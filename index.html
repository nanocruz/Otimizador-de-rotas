<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Otimizador de Rotas Inteligente</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://serratus.github.io/quaggaJS/dist/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            padding: 0 10px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .status-bar {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }

        .tip-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .tip-box strong {
            display: block;
            margin-bottom: 5px;
            color: #1565c0;
        }

        .tip-box small {
            display: block;
            margin-top: 8px;
            font-size: 12px;
            color: #555;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        input[type="text"] {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.95);
            background: #5568d3;
        }

        .btn-voice {
            background: #f0f0f0;
            color: #333;
            flex: 1;
        }

        .btn-voice.listening {
            background: #ef5350;
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .btn-optimize {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 18px;
            padding: 18px;
        }

        .btn-optimize:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-ok {
            padding: 10px 15px;
            font-size: 14px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            min-width: 60px;
            flex-shrink: 0;
        }

        .btn-ok:hover {
            background: #45a049;
        }

        .btn-small {
            padding: 10px 15px;
            font-size: 14px;
        }

        .buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .address-list {
            margin-bottom: 20px;
        }

        .address-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .address-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .address-text {
            flex: 1;
            font-size: 14px;
        }

        .btn-delete {
            background: #ff5252;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            flex-shrink: 0;
        }

        .route-item {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
        }

        .route-item.active {
            background: #e8eaf6;
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .route-item.completed {
            background: #e8f5e9;
            border-color: #4caf50;
        }

        .route-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 15px;
        }

        .route-number {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .route-number.active {
            background: #667eea;
            color: white;
        }

        .route-number.completed {
            background: #4caf50;
            color: white;
        }

        .route-text {
            flex: 1;
        }

        .route-text strong {
            display: block;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .route-text small {
            color: #666;
            font-size: 13px;
        }

        .route-info {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 13px;
            color: #555;
        }

        .route-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 8px;
        }

        .btn-maps {
            background: #4285f4;
            color: white;
        }

        .btn-waze {
            background: #00d9ff;
            color: white;
        }

        .btn-complete {
            background: #4caf50;
            color: white;
            width: 45px;
        }

        .progress-bar {
            background: #e8eaf6;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
        }

        .progress-bar strong {
            color: #667eea;
            font-size: 18px;
        }

        .stats-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .stats-box strong {
            display: block;
            margin-bottom: 8px;
            color: #e65100;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
        }

        .stat-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            opacity: 0.3;
            margin-bottom: 15px;
        }

        #camera-container {
            margin-bottom: 20px;
        }

        #camera-video {
            width: 100%;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .camera-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .btn-capture {
            background: #4caf50;
            color: white;
        }

        .btn-cancel {
            background: #f44336;
            color: white;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .btn-reset {
            background: #f44336;
            color: white;
        }

        .base-location-section {
            background: #fff8e1;
            border: 2px dashed #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .base-location-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .base-location-input-group input {
            flex: 1;
        }

        .base-location-display {
            font-size: 14px;
            color: #555;
            text-align: center;
            margin-top: 10px;
        }

        .optimization-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="3 11 22 2 13 21 11 13 3 11"></polygon>
                </svg>
                Otimizador de Rotas
                <span class="optimization-badge">SMART</span>
            </h1>
            <div class="subtitle">üöÄ Rota mais r√°pida com dist√¢ncias reais por estrada</div>
        </div>

        <div id="status-container"></div>

        <div id="base-location-section" class="card base-location-section">
            <h3 style="margin-bottom: 10px; color: #333;">üìç Localiza√ß√£o Base</h3>
            <p style="margin-bottom: 15px; font-size: 14px; color: #555;">Defina a cidade/regi√£o onde voc√™ deseja adicionar os endere√ßos.</p>

            <div class="base-location-input-group">
                <input type="text" id="base-location-input" placeholder="Ex: S√£o Paulo, SP">
                <button class="btn btn-ok" onclick="setBaseLocation()">‚úÖ</button>
            </div>

            <div id="base-location-display" class="base-location-display">
                Nenhuma localiza√ß√£o base definida. Por favor, defina para continuar.
            </div>
        </div>

        <div id="add-section" class="card">
            <h2 style="margin-bottom: 15px; color: #333;">üìù Adicionar Endere√ßos</h2>

            <div class="tip-box">
                <strong>üí° Dica de uso:</strong>
                Use endere√ßos completos para melhores resultados! O sistema calcular√° a rota mais r√°pida considerando o tr√¢nsito real.
                <small>Exemplos: "Av. Paulista, 1578, S√£o Paulo, SP" ‚Ä¢ "Rua XV de Novembro, 391, Curitiba, PR" ‚Ä¢ "85855-185, 555"</small>
            </div>

            <div class="input-group">
                <input type="text" id="address-input" placeholder="Ex: Av. Paulista, 1578, S√£o Paulo, SP">
                <button class="btn btn-primary" onclick="addAddress()">+</button>
            </div>

            <div class="buttons-grid">
                <button class="btn btn-voice" id="voice-btn" onclick="requestVoicePermissionAndStart()">
                    üé§ Voz
                </button>
                <button class="btn btn-voice" onclick="requestCameraPermissionAndStart('photo')">
                    üì∑ Foto
                </button>
                <button class="btn btn-voice" onclick="requestCameraPermissionAndStart('barcode')">
                    üìä C√≥digo de Barras
                </button>
                <button class="btn btn-voice" onclick="requestCameraPermissionAndStart('qr')">
                    üî≤ QR Code
                </button>
                <button class="btn btn-voice" onclick="addUserLocationManually()">
                    üìç Minha Posi√ß√£o
                </button>
            </div>

            <div id="camera-container" style="display: none;">
                <video id="camera-video" autoplay playsinline></video>
                <div class="camera-buttons" id="camera-buttons">
                    <button class="btn btn-capture" onclick="captureImage()">Capturar</button>
                    <button class="btn btn-cancel" onclick="stopCamera()">Cancelar</button>
                </div>
            </div>

            <div id="address-list" class="address-list"></div>

            <button id="optimize-btn" class="btn btn-optimize" onclick="optimizeRoute()" style="display: none;">
                üöÄ Otimizar Rota Inteligente
            </button>
        </div>

        <div id="route-section" class="card" style="display: none;">
            <div class="header-actions">
                <h2 style="color: #333;">üéØ Rota Otimizada</h2>
                <button class="btn btn-reset btn-small" onclick="resetRoute()">‚úï Reiniciar</button>
            </div>
            
            <div class="stats-box">
                <strong>üìä Estat√≠sticas da Rota</strong>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="total-distance">-</div>
                        <div class="stat-label">Dist√¢ncia Total</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-time">-</div>
                        <div class="stat-label">Tempo Estimado</div>
                    </div>
                </div>
            </div>

            <div id="route-list"></div>
            <div id="progress-bar" class="progress-bar"></div>
        </div>
    </div>

    <script>
        let addresses = [];
        let optimizedRoute = [];
        let activeIndex = 0;
        let userLocation = null;
        let isListening = false;
        let cameraStream = null;
        let scannerType = null;
        let isPhotoMode = false;
        let totalDistance = 0;
        let totalTime = 0;

        // Servidor OSRM p√∫blico gratuito
        const OSRM_SERVER = 'https://router.project-osrm.org';

        window.onload = () => {
            document.getElementById('address-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addAddress();
            });
            document.getElementById('address-input').placeholder = 'Ex: Av. Paulista, 1578, S√£o Paulo, SP';
        };

        function showStatus(message, type = 'info') {
            const container = document.getElementById('status-container');
            const className = type === 'success' ? 'status-success' : type === 'warning' ? 'status-warning' : 'status-info';
            container.innerHTML = `<div class="status-bar ${className}">${message}</div>`;
            if (type !== 'warning') {
                setTimeout(() => container.innerHTML = '', 5000);
            }
        }

        function setBaseLocation() {
            const input = document.getElementById('base-location-input');
            const locationText = input.value.trim();
            if (!locationText) {
                showStatus('Por favor, informe uma localiza√ß√£o base (cidade e estado).', 'warning');
                return;
            }
            geocodeBaseLocation(locationText);
        }

        async function geocodeBaseLocation(locationText) {
            showStatus('Verificando localiza√ß√£o base...', 'info');
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationText)}, Brasil&limit=1&addressdetails=1&accept-language=pt-BR`,
                    { headers: { 'User-Agent': 'RouteOptimizerApp/1.0' }}
                );
                const data = await response.json();
                if (data && data.length > 0) {
                    const result = data[0];
                    const address = result.address || {};
                    const city = address.city || address.town || address.municipality || address.village || '';
                    const state = address.state || '';

                    if (city) {
                        userLocation = { city, state };
                        document.getElementById('base-location-display').textContent = `Localiza√ß√£o base definida: ${city}${state ? ', ' + state : ''}.`;
                        document.getElementById('address-input').placeholder = `Ex: Rua das Flores, 123 (buscando em ${city})`;
                        showStatus(`‚úÖ Localiza√ß√£o base definida: ${city}${state ? ', ' + state : ''}`, 'success');
                    } else {
                        throw new Error('Cidade n√£o identificada na resposta.');
                    }
                } else {
                    throw new Error('Nenhum resultado encontrado para a localiza√ß√£o base.');
                }
            } catch (error) {
                console.error('Erro ao geocodificar localiza√ß√£o base:', error);
                showStatus('‚ùå Erro ao definir localiza√ß√£o base: ' + error.message, 'warning');
                userLocation = null;
                document.getElementById('base-location-display').textContent = 'Falha ao definir localiza√ß√£o base.';
            }
        }

        async function addAddress() {
            if (!userLocation) {
                showStatus('‚ö†Ô∏è Por favor, defina uma localiza√ß√£o base primeiro.', 'warning');
                return;
            }

            const input = document.getElementById('address-input');
            let text = input.value.trim();
            if (!text) return;

            const cepMatch = text.match(/^(\d{5}-?\d{3})(?:,\s*(\d+))?$/);
            if (cepMatch) {
                const cep = cepMatch[1].replace('-', '');
                const numero = cepMatch[2] || '';
                showStatus('üîç Buscando CEP nos Correios...', 'info');
                try {
                    const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const data = await response.json();
                    if (data.erro) {
                        throw new Error('CEP inv√°lido');
                    }
                    text = `${data.logradouro || ''} ${numero ? ' ' + numero : ''}, ${data.bairro || ''}, ${userLocation.city}, ${userLocation.state}`;
                    showStatus('‚úÖ Endere√ßo encontrado: ' + text, 'success');
                } catch (error) {
                    showStatus('‚ùå Erro ao buscar CEP: ' + error.message, 'warning');
                    return;
                }
            }

            addresses.push({ id: Date.now(), text, completed: false });
            input.value = '';
            renderAddressList();
            if (addresses.length > 0) {
                document.getElementById('optimize-btn').style.display = 'block';
            }
        }

        function addUserLocationManually() {
            if (!userLocation) {
                showStatus('‚ö†Ô∏è Por favor, defina uma localiza√ß√£o base primeiro.', 'warning');
                return;
            }
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const { latitude, longitude } = position.coords;
                        try {
                            const response = await fetch(
                                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&accept-language=pt-BR`,
                                { headers: { 'User-Agent': 'RouteOptimizerApp/1.0' }}
                            );
                            const data = await response.json();
                            const displayName = data.display_name || `Minha Posi√ß√£o (${latitude.toFixed(6)}, ${longitude.toFixed(6)})`;

                            const text = `üìç Minha localiza√ß√£o atual`;
                            addresses.unshift({ id: Date.now(), text, completed: false, coords: { lat: latitude, lon: longitude, display_name: displayName } });
                            renderAddressList();
                            document.getElementById('optimize-btn').style.display = 'block';
                            showStatus('‚úÖ Posi√ß√£o atual adicionada como parada.', 'success');
                        } catch (error) {
                            const text = `üìç Minha localiza√ß√£o atual (${latitude.toFixed(6)}, ${longitude.toFixed(6)})`;
                            addresses.unshift({ id: Date.now(), text, completed: false, coords: { lat: latitude, lon: longitude, display_name: text } });
                            renderAddressList();
                            document.getElementById('optimize-btn').style.display = 'block';
                            showStatus('‚úÖ Posi√ß√£o atual adicionada.', 'success');
                        }
                    },
                    (error) => {
                        let errorMessage = 'Erro desconhecido.';
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMessage = 'Permiss√£o negada para obter localiza√ß√£o.';
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            errorMessage = 'Informa√ß√µes de localiza√ß√£o indispon√≠veis.';
                        } else if (error.code === error.TIMEOUT) {
                            errorMessage = 'Tempo limite excedido.';
                        }
                        showStatus('‚ùå Erro ao adicionar posi√ß√£o: ' + errorMessage, 'warning');
                    },
                    { timeout: 10000, enableHighAccuracy: false }
                );
            } else {
                showStatus('‚ö†Ô∏è Geolocaliza√ß√£o n√£o suportada.', 'warning');
            }
        }

        function removeAddress(id) {
            addresses = addresses.filter(a => a.id !== id);
            renderAddressList();
            if (addresses.length === 0) {
                document.getElementById('optimize-btn').style.display = 'none';
            }
        }

        function renderAddressList() {
            const list = document.getElementById('address-list');
            if (addresses.length === 0) {
                list.innerHTML = '';
                return;
            }
            list.innerHTML = addresses.map((addr, i) => `
                <div class="address-item">
                    <div class="address-number">${i + 1}</div>
                    <div class="address-text">${addr.text}</div>
                    <button class="btn-delete" onclick="removeAddress(${addr.id})">üóë</button>
                </div>
            `).join('');
        }

        function requestVoicePermissionAndStart() {
            if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
                showStatus('‚ö†Ô∏è Reconhecimento de voz n√£o suportado.', 'warning');
                return;
            }
            if (!userLocation) {
                showStatus('‚ö†Ô∏è Por favor, defina uma localiza√ß√£o base primeiro.', 'warning');
                return;
            }
            startVoice();
        }

        function startVoice() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            const btn = document.getElementById('voice-btn');
            btn.disabled = true;

            recognition.onstart = () => {
                isListening = true;
                btn.classList.add('listening');
                btn.textContent = 'üé§ Ouvindo...';
                showStatus('üé§ Fale o endere√ßo agora...', 'info');
            };

            recognition.onend = () => {
                isListening = false;
                btn.classList.remove('listening');
                btn.textContent = 'üé§ Voz';
                btn.disabled = false;
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.trim();
                document.getElementById('address-input').value = transcript;
                addAddress();
            };

            recognition.onerror = (event) => {
                let errorMessage = event.error;
                if (event.error === 'no-speech') {
                    errorMessage = 'Nenhum √°udio detectado.';
                } else if (event.error === 'audio-capture') {
                    errorMessage = 'Microfone n√£o dispon√≠vel.';
                } else if (event.error === 'not-allowed') {
                    errorMessage = 'Permiss√£o de microfone negada.';
                }
                showStatus('‚ùå Erro na voz: ' + errorMessage, 'warning');
                recognition.onend();
            };

            try {
                recognition.start();
            } catch (error) {
                showStatus('‚ùå Erro ao iniciar voz: ' + error.message, 'warning');
                btn.disabled = false;
            }
        }

        async function requestCameraPermissionAndStart(mode) {
            if (!userLocation) {
                showStatus('‚ö†Ô∏è Por favor, defina uma localiza√ß√£o base primeiro.', 'warning');
                return;
            }
            if (mode === 'photo') {
                isPhotoMode = true;
                document.getElementById('camera-buttons').innerHTML = `
                    <button class="btn btn-capture" onclick="captureImage()">Capturar</button>
                    <button class="btn btn-cancel" onclick="stopCamera()">Cancelar</button>
                `;
            } else {
                isPhotoMode = false;
                scannerType = mode;
                document.getElementById('camera-buttons').innerHTML = `
                    <button class="btn btn-cancel" onclick="stopCamera()">Cancelar</button>
                `;
            }
            await startCamera();
        }

        async function startCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('camera-video').srcObject = cameraStream;
                document.getElementById('camera-container').style.display = 'block';

                if (!isPhotoMode && scannerType) {
                    const video = document.getElementById('camera-video');
                    video.onloadeddata = () => {
                        const canvas = document.createElement('canvas');
                        const interval = setInterval(() => {
                            if (video.videoWidth > 0 && video.videoHeight > 0 && scannerType) {
                                canvas.width = video.videoWidth;
                                canvas.height = video.videoHeight;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                                if (scannerType === 'qr') {
                                    const code = jsQR(imageData.data, canvas.width, canvas.height);
                                    if (code) {
                                        handleScannedCode(code.data);
                                        clearInterval(interval);
                                        stopCamera();
                                    }
                                } else if (scannerType === 'barcode') {
                                    Quagga.decodeSingle({
                                        decoder: { readers: ['code_128_reader', 'ean_reader', 'ean_8_reader', 'code_39_reader', 'code_39_vin_reader', 'codabar_reader', 'upc_reader', 'upc_e_reader', 'i2of5_reader'] },
                                        locate: true,
                                        src: canvas.toDataURL('image/png')
                                    }, (result) => {
                                        if (result && result.codeResult) {
                                            handleScannedCode(result.codeResult.code);
                                            clearInterval(interval);
                                            stopCamera();
                                        }
                                    });
                                }
                            }
                        }, 300);
                    };
                }
            } catch (error) {
                console.error('Erro ao acessar c√¢mera:', error);
                let errorMessage = 'Erro desconhecido.';
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Permiss√£o de c√¢mera negada.';
                } else if (error.name === 'NotFoundError' || error.name === 'OverconstrainedError') {
                    errorMessage = 'C√¢mera n√£o encontrada.';
                }
                showStatus('‚ùå Erro ao acessar c√¢mera: ' + errorMessage, 'warning');
                document.getElementById('camera-container').style.display = 'none';
                isPhotoMode = false;
                scannerType = null;
            }
        }

        async function captureImage() {
            const video = document.getElementById('camera-video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            showStatus('üîç Extraindo texto da imagem...', 'info');
            try {
                const { data: { text } } = await Tesseract.recognize(
                    canvas.toDataURL('image/png'),
                    'por',
                    { logger: m => console.log(m) }
                );
                const cleanedText = text.trim().replace(/\n/g, ' ');
                document.getElementById('address-input').value = cleanedText;
                addAddress();
                showStatus('‚úÖ Texto extra√≠do: ' + cleanedText, 'success');
            } catch (err) {
                console.error("Erro no OCR:", err);
                showStatus('‚ùå Erro no OCR: ' + err.message, 'warning');
            }
            stopCamera();
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('camera-container').style.display = 'none';
            isPhotoMode = false;
            scannerType = null;
        }

        function handleScannedCode(code) {
            document.getElementById('address-input').value = code;
            addAddress();
            showStatus('‚úÖ C√≥digo escaneado: ' + code, 'success');
        }

        function matchesBaseCity(result_address, base_city) {
            if (!base_city) return true;
            const result_city = (result_address.city || result_address.town || result_address.municipality || result_address.village || '').toLowerCase();
            return result_city.includes(base_city.toLowerCase());
        }

        async function geocodeAddress(address) {
            if (!userLocation || !userLocation.city) {
                showStatus('‚ùå Erro: Localiza√ß√£o base n√£o definida.', 'warning');
                return null;
            }

            try {
                let searchQuery = address;
                if (!address.toLowerCase().includes(userLocation.city.toLowerCase())) {
                    searchQuery += `, ${userLocation.city}`;
                }
                if (userLocation.state && !address.toLowerCase().includes(userLocation.state.toLowerCase())) {
                    searchQuery += `, ${userLocation.state}`;
                }
                searchQuery += `, Brasil`;

                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=1&addressdetails=1&accept-language=pt-BR`,
                    { headers: { 'User-Agent': 'RouteOptimizerApp/1.0' }}
                );

                const data = await response.json();
                if (data && data.length > 0) {
                    const result = data[0];
                    if (matchesBaseCity(result.address, userLocation.city)) {
                        return {
                            lat: parseFloat(result.lat),
                            lon: parseFloat(result.lon),
                            display_name: result.display_name
                        };
                    }
                }
                return null;
            } catch (error) {
                console.error('Erro ao geocodificar:', error);
                return null;
            }
        }

        // Fun√ß√£o para calcular dist√¢ncia e tempo real usando OSRM
        async function getRouteDistance(coord1, coord2) {
            try {
                const url = `${OSRM_SERVER}/route/v1/driving/${coord1.lon},${coord1.lat};${coord2.lon},${coord2.lat}?overview=false`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
                    return {
                        distance: data.routes[0].distance / 1000, // em km
                        duration: data.routes[0].duration / 60 // em minutos
                    };
                }
                return null;
            } catch (error) {
                console.error('Erro ao calcular dist√¢ncia OSRM:', error);
                return null;
            }
        }

        // Matriz de dist√¢ncias
        async function buildDistanceMatrix(coords) {
            const n = coords.length;
            const matrix = Array(n).fill(null).map(() => Array(n).fill(null));
            
            showStatus('üìä Calculando dist√¢ncias reais entre todos os pontos...', 'info');
            
            for (let i = 0; i < n; i++) {
                for (let j = i + 1; j < n; j++) {
                    const route = await getRouteDistance(coords[i], coords[j]);
                    if (route) {
                        matrix[i][j] = route;
                        matrix[j][i] = route;
                    } else {
                        // Fallback para dist√¢ncia euclidiana se OSRM falhar
                        const dist = calculateHaversineDistance(
                            coords[i].lat, coords[i].lon,
                            coords[j].lat, coords[j].lon
                        );
                        matrix[i][j] = { distance: dist, duration: dist * 2 }; // estima 30km/h
                        matrix[j][i] = matrix[i][j];
                    }
                    // Pequeno delay para n√£o sobrecarregar API
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                showStatus(`üìä Progresso: ${Math.round((i+1)/n * 100)}% conclu√≠do`, 'info');
            }
            
            return matrix;
        }

        // Dist√¢ncia Haversine (fallback)
        function calculateHaversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Algoritmo 2-opt para otimiza√ß√£o
        function twoOptOptimization(route, distMatrix) {
            let improved = true;
            let bestRoute = [...route];
            
            while (improved) {
                improved = false;
                for (let i = 1; i < bestRoute.length - 2; i++) {
                    for (let j = i + 1; j < bestRoute.length - 1; j++) {
                        const currentDist = 
                            distMatrix[bestRoute[i-1]][bestRoute[i]].distance +
                            distMatrix[bestRoute[j]][bestRoute[j+1]].distance;
                        
                        const newDist = 
                            distMatrix[bestRoute[i-1]][bestRoute[j]].distance +
                            distMatrix[bestRoute[i]][bestRoute[j+1]].distance;
                        
                        if (newDist < currentDist) {
                            // Inverte o segmento
                            const newRoute = [
                                ...bestRoute.slice(0, i),
                                ...bestRoute.slice(i, j + 1).reverse(),
                                ...bestRoute.slice(j + 1)
                            ];
                            bestRoute = newRoute;
                            improved = true;
                        }
                    }
                }
            }
            
            return bestRoute;
        }

        async function optimizeRoute() {
            if (!userLocation || !userLocation.city) {
                showStatus('‚ö†Ô∏è Por favor, defina uma localiza√ß√£o base primeiro.', 'warning');
                return;
            }
            if (addresses.length === 0) return;

            const btn = document.getElementById('optimize-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Otimizando...';

            showStatus('üöÄ Iniciando otimiza√ß√£o inteligente...', 'info');

            try {
                const geocodedAddresses = [];

                for (let i = 0; i < addresses.length; i++) {
                    showStatus(`üìç Localizando endere√ßo ${i + 1} de ${addresses.length}...`, 'info');
                    let coords = addresses[i].coords;
                    if (!coords) {
                        coords = await geocodeAddress(addresses[i].text);
                    }

                    if (coords) {
                        geocodedAddresses.push({ ...addresses[i], coords });
                    } else {
                        showStatus(`‚ö†Ô∏è Endere√ßo "${addresses[i].text}" n√£o encontrado.`, 'warning');
                    }

                    if (i < addresses.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }

                const validAddresses = geocodedAddresses.filter(addr => addr.coords !== null);

                if (validAddresses.length === 0) {
                    showStatus('‚ùå N√£o foi poss√≠vel localizar nenhum endere√ßo.', 'warning');
                    btn.disabled = false;
                    btn.textContent = 'üöÄ Otimizar Rota Inteligente';
                    return;
                }

                if (validAddresses.length === 1) {
                    optimizedRoute = validAddresses;
                    totalDistance = 0;
                    totalTime = 0;
                } else {
                    // Construir matriz de dist√¢ncias
                    const coords = validAddresses.map(a => a.coords);
                    const distMatrix = await buildDistanceMatrix(coords);
                    
                    showStatus('üßÆ Calculando melhor rota com algoritmo 2-opt...', 'info');
                    
                    // Algoritmo Vizinho Mais Pr√≥ximo inicial
                    let route = [0];
                    let remaining = Array.from({length: validAddresses.length}, (_, i) => i).slice(1);
                    
                    while (remaining.length > 0) {
                        const current = route[route.length - 1];
                        let nearest = remaining[0];
                        let minDist = distMatrix[current][nearest].distance;
                        
                        for (const idx of remaining) {
                            if (distMatrix[current][idx].distance < minDist) {
                                minDist = distMatrix[current][idx].distance;
                                nearest = idx;
                            }
                        }
                        
                        route.push(nearest);
                        remaining = remaining.filter(x => x !== nearest);
                    }
                    
                    // Otimiza√ß√£o 2-opt
                    route = twoOptOptimization(route, distMatrix);
                    
                    // Converte √≠ndices para endere√ßos
                    optimizedRoute = route.map(idx => validAddresses[idx]);
                    
                    // Calcula dist√¢ncia e tempo totais
                    totalDistance = 0;
                    totalTime = 0;
                    for (let i = 0; i < route.length - 1; i++) {
                        totalDistance += distMatrix[route[i]][route[i+1]].distance;
                        totalTime += distMatrix[route[i]][route[i+1]].duration;
                    }
                }

                activeIndex = 0;
                document.getElementById('base-location-section').style.display = 'none';
                document.getElementById('add-section').style.display = 'none';
                document.getElementById('route-section').style.display = 'block';
                document.getElementById('status-container').innerHTML = '';
                
                // Atualiza estat√≠sticas
                document.getElementById('total-distance').textContent = totalDistance.toFixed(1) + ' km';
                document.getElementById('total-time').textContent = Math.round(totalTime) + ' min';
                
                renderRoute();
                showStatus('‚úÖ Rota otimizada com sucesso!', 'success');

            } catch (error) {
                console.error("Erro na otimiza√ß√£o:", error);
                showStatus('‚ùå Erro ao otimizar rota: ' + error.message, 'warning');
                btn.disabled = false;
                btn.textContent = 'üöÄ Otimizar Rota Inteligente';
            }
        }

        function renderRoute() {
            const list = document.getElementById('route-list');
            list.innerHTML = optimizedRoute.map((addr, i) => {
                const isActive = i === activeIndex && !addr.completed;
                const isCompleted = addr.completed;

                return `
                    <div class="route-item ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}">
                        <div class="route-header">
                            <div class="route-number ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}">
                                ${isCompleted ? '‚úì' : i + 1}
                            </div>
                            <div class="route-text">
                                <strong>${addr.text}</strong>
                                ${addr.coords ? `<small>${addr.coords.display_name}</small>` : ''}
                            </div>
                        </div>
                        ${isActive && !isCompleted ? `
                            <div class="route-buttons">
                                <button class="btn btn-maps btn-small" onclick="openMaps(${i}, 'google')">Google Maps</button>
                                <button class="btn btn-waze btn-small" onclick="openMaps(${i}, 'waze')">Waze</button>
                                <button class="btn btn-complete btn-small" onclick="markCompleted(${i})">‚úì</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            updateProgress();
        }

        function openMaps(index, app) {
            const addr = optimizedRoute[index];
            const lat = addr.coords?.lat;
            const lon = addr.coords?.lon;

            let url;
            if (app === 'google') {
                if (lat && lon) {
                    url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
                } else {
                    const encoded = encodeURIComponent(addr.text);
                    url = `https://www.google.com/maps/search/?api=1&query=${encoded}`;
                }
                window.open(url, '_blank');
            } else if (app === 'waze') {
                if (lat && lon) {
                    const wazeUrl = `waze://?ll=${lat},${lon}&navigate=yes`;
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = wazeUrl;
                    document.body.appendChild(iframe);

                    setTimeout(() => {
                        document.body.removeChild(iframe);
                        if (document.hasFocus()) {
                            const webUrl = `https://www.waze.com/ul?ll=${lat},${lon}&navigate=yes`;
                            window.open(webUrl, '_blank');
                            showStatus('‚ÑπÔ∏è Waze n√£o encontrado. Abrindo no navegador...', 'info');
                        }
                    }, 2000);
                } else {
                    const encoded = encodeURIComponent(addr.text);
                    const webUrl = `https://www.waze.com/ul?q=${encoded}`;
                    window.open(webUrl, '_blank');
                }
            }
        }

        function markCompleted(index) {
            optimizedRoute[index].completed = true;
            if (index < optimizedRoute.length - 1) {
                activeIndex = index + 1;
            }
            renderRoute();
        }

        function updateProgress() {
            const completed = optimizedRoute.filter(a => a.completed).length;
            const total = optimizedRoute.length;
            document.getElementById('progress-bar').innerHTML = `
                <strong>${completed} de ${total}</strong> paradas conclu√≠das
            `;
        }

        function resetRoute() {
            optimizedRoute = [];
            activeIndex = 0;
            totalDistance = 0;
            totalTime = 0;
            document.getElementById('base-location-section').style.display = 'block';
            document.getElementById('add-section').style.display = 'block';
            document.getElementById('route-section').style.display = 'none';
            addresses = [];
            renderAddressList();
            document.getElementById('optimize-btn').style.display = 'none';
            document.getElementById('status-container').innerHTML = '';
        }
    </script>
</body>
</html>
